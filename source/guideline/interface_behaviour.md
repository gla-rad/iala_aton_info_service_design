\pagebreak

# Service Interface Behaviour {#sec:interface-behaviour}

As defined by SECOM, all communication between the components of the service that are in the scope of this design document is achieved via REST calls.

Additional information on the interfaces and parameters is available in the attached OpenAPI template of service in the Annex of [@sec:openapi].

## Common {#sec:interface_behaviour_common}

The definitions of the service interfaces in this section, assume the following actors:

* An AtoN information provision service, identified as the *Data Provider/Server*.
* A digital communication device onboard the ship (interconnected with the ship's ECDIS), identified as the *Data Receiver/Consumer*.

All parameters that are not set, should be omitted or can passed with a null value.

###	Common parameter values {#sec:interface_behaviour_common_params}

For all interfaces, the following parameter values must be used when applicable:

* ***containerType*** - should match the container type used to package the AtoN information (i.e. "0" for S-125 datasets and "1" for S-100 Exchange-Sets).
* ***dataProductType*** - must always be "S-125".
* ***dataProductVersion*** -must be the S-125 version expected.
* ***exchangeMetadata*** - must contain all field mandated by SECOM for the secure exchange of AtoN information.
* ***protectionScheme*** - must always be "SECOM".
* ***transactionIdentifier*** (transactionId) - must be a UUID. It must be unique for each transaction.

For SECOM v2.0 services only: 

* ***callbackEndpoint*** - The endpoint of the consumer’s SECOM v2.0 service that accepts the interface calls. The endpoint must be defined in a way that appending the SECOM standard REST endpoints (e.g. /v2/subscription) produces a valid URL. If the callbackEndpoint is not a part of the subscription, the service must search for the vessel’s SECOM service from a service registry.

###	Error codes {#sec:interface_behaviour_common_error_codes}

If incoming route does not pass business rule validation, the SECOM_ResponseCode must be 0.

If the signature verification fails, the SECOM_ResponseCode must be 1.

If certificate provided is invalid, the SECOM_ResponseCode must be 2.

If incoming route does not pass schema validation, the SECOM_ResponseCode must be 3.

In all of these cases, the response returned to the client must have the HTTP status 400.

## Applicable SECOM Interfaces {#sec:interface_behaviour_applicable_interfaces}

All interface descriptions below only have the information necessary for the business logic of this service. All definitions and descriptions that are directly derived from the SECOM standard are left to be read from the SECOM standard and the API documentation template in the Annex of [@sec:openapi].

All SECOM communication is done via REST APIs with JSON as the data format for the SECOM data and XML for the S-125 data.

For all operations only those parameters that have predefined values or their usage needs to be explained are described below. Otherwise refer to SECOM [@cite:iec-63173-2].

The ***Capability***, ***Ping***, ***EncryptionKey*** and ***PublicKey*** interfaces are not discussed in this design as they follow the requirements defined in SECOM and further elaboration is necessary.

As per the SECOM standard, the provider must sign the data response using a valid certificate generated by the employed SECOM PKI. The signature, the public certificate, the root certificate and any intermediate certificates of the PKI, must all be present in the response.

### Operation Get {#sec:interface_behaviour_operation_get}

The *Get* operation is used by data consumers for retrieving AtoN information directly from a data provider, i.e. S-125 datasets that are applicable for a specified geographical area. The consumer can filter the requested S-125 dataset results through parameters like the dataset identifier, validity period and/or geometry etc.

The Get operation interface must be implemented only by the data provider.

Use of the interface is according to the SECOM specification.

  * Name: Get Interface 
  * Sub-path: /v2/object
  * HTTP-Method: GET
  * Cookies: Session-Cookies (optional)
  * Content-Type: application/json

#### Operation Functionality {#sec:interface_behaviour_operation_get_func}

All instances of this service design must provide access to all S-125 datasets made available for their advertised coverage area. Each individual S-125 dataset should have a fixed, globally unique, MRN identifier associated with it. In addition, each update on any of the datasets must be identified using a different, locally unique, UUID.

The operation supports multiple filter parameters, presented in more detail in [@tbl:get_operation_parameters]. To ensure the authenticity of the operation request, the filter parameters are included within a signed SECOM envelope structure. Data provider instances are required to support all referenced filter parameters.

If multiple filter parameters are provided, only results that match all requested filters, combined with logical AND, must be returned. If no parameters are given, the response is either an empty list or all available datasets for  which has been given access to by the data provider. A data provider must offer the appropriate encoding of AtoN information in accordance with the S-125 standard.

Depending on the combination of the  **containterType** and **validFrom**/**validTo** input parameter values, the service must respond differently:

* For the **containterType** set to **0** (S-100 Dataset): the service must respond with the matching S-125 datasets containing all the latest information on the AtoNs included in them. The **validFrom**/**validTo** should not be taken into account, as the data provider must never return out-of-date information. If however, the specified **dataReference** UUIDs represent the past state of a valid S-125 dataset (with the same MRN), *which has not been cancelled yet*, then the data provider must return that exact dataset, once again disregarding the **validFrom**/**validTo** parameters. *The service must never return S-125 **delta** files if the containterType value is set to 0*.
* For the **containterType** set to **1** (S-100 Exchange-Set): the service must return the dataset using the S-100 Exchange-Set structure. That involves the original content of the S-125 dataset (update 0), along with any incremental updates (for the same dataset MRN) in the form of S-100 ***delta*** files. If the **validFrom**/**validTo** parameters are utilised, any of the original content of the S-125 dataset and delta files should only be included in the Exchange-Set, if they falls within the specified time interval.

#### Operation Parameters {#sec:interface_behaviour_operation_get_params}

| Parameters (in) | Encoding | Mult. | Descriptions |
| --- | --- | ---  | --- |
| containerType | Integer | 0..1 | Requested encoding of the data as described in [@cite:iec-63173-2]. If not provided, the service provider determines the standard encoding. |
| dataProductType | String | 0..1 | Data product type as described in [@cite:iec-63173-2]. |
| productVersion | String | 0..1 | S-100 based Product type version, e.g. 1.0.0. |
| dataReference | UUID | 0..1 | Dataset reference identifier to a specific S-125 dataset. The reference can be provided as search criteria. A list of references can be retrieved via Get Summary interface. |
| geometry | String (WKT) | 0..1| Geometry condition for geo-located information objects in WKT format. This can be used to filter on geometric shapes (e.g., filter S-125 datasets by a bounding box). |
| unlocode | String | 0..1 | UN/LOCODE (United Nations Code for Trade and Transport Locations) of a defined object (e.g., “CN” for China). |
| validFrom | DateTime | 0..1| Describes the start of the validity time for the requested data in ISO 8601 UTC formatted as yyyy-mm-dd hh:mm:ssZ. |
| validTo | DateTime | 0..1 | Describes the end of the validity time for the requested data in ISO 8601 UTC formatted as yyyy-mm-dd hh:mm:ssZ. |
| page | Integer | 0..1 | The number of the page for retrieving paged results. If not provided, the default value of this parameter is set to zero (0). |
| pageSize | Integer | 0..1 | The size of each page in a paged result. If not provided, the default value of this parameter is not set and the resulting S-125 datasets are not paged. |

: The Get Operation Parameters. {#tbl:get_operation_parameters}

#### Interpretation Guidelines {#sec:interface_behaviour_operation_get_guide}

If no data is returned, the response is HTTP code 404.

If the size of the data to be returned in more than the limit set by SECOM (i.e.  350 kbs), an HTTP 413 error code is expected from the data provider. In that case the data consumer should make use of the Get By Link operation, described in [@sec:interface_behaviour_operation_get_by_link].

The **dataReference** is used when a known data object is retrieved. The dataReference is provided in the response from Get Summary and is typically an UUID.

The **containterType** describes how the data is packaged, e.g. 0 for a S-100 DataSet, 1 for a S-100 Exchange-Set or 2 for no specific container, e.g. RTZ in XML.

The **dataProductType** is a string describing which data product that is in focus in the operation. For the purpose of this service design, it must always be "S-125" as per the format specified in S-100 [@cite:iho-s100].

The **productVersion** describes the specific version of the data product specification of the data requested.

The **geometry** describes geographical criteria for the data requested. The geometry is given as a one-line WKT formatted string and can contain one or more geospatial objects. 

The **unlocode** describes with 5 characters the UN code for city or other area, such as a port. The unlocode is a list administered by UN and can be found online. Many unlocodes have a position in longitude/latitude attached, but not all. In most cases the unlocode will be used as text only but this may depend on the service developer.

The **validFrom**/**validTo** describes the requested validity time for the requested data in ISO 8601 UTC formatted as yyyy-mm-dd hh:mm:ssZ.


### Operation Get by Link {#sec:interface_behaviour_operation_get_by_link}

The *Get by Link* operation is used by data consumers for retrieving large AtoN informatdatasets ion directly from a data provider. This interface shall be used instead of the Get, when the size of the data to be exchanged exceeds the SECOM limit (i.e. 350kbs). The consumer in this case cannot filter the pre-prepared results any further.

The Get by Link operation interface must be implemented only by the data provider.

Use of the interface is according to the SECOM specification.

  * Name: Get by Link Interface 
  * Sub-path: /v2/object/link
  * HTTP-Method: GET
  * Cookies: Session-Cookies (optional)
  * Content-Type: application/json

#### Operation Functionality {#sec:interface_behaviour_operation_get_by_link_func}

The operation validates the given transactionIdentifier against the caller’s identity and the timeToLive given for the data. The data is then packaged according to agreement in Upload By Link and returned in the call.

#### Operation Parameters {#sec:interface_behaviour_operation_get_by_link_params}

| Parameters (in) | Encoding | Mult. | Descriptions |
| --- | --- | ---  | --- |
| transactionIdentifier | UUID | 1 | Identifier uploaded in Upload Link |
| envelopeSignatureCertificate | String | 1..* | The public certificate(s) of the sender. Used to verify the envelope signature. |
| envelopeRootCertificateThumbprint | String| 1 | Claimed Thumbprint for Signed Root Key (X.509 Certificate) SHA256 and base64 as format. |
| envelopeSignatureTime | DateTime | 1 | Timestamp when the envelope is signed envelope. | 
| SignatureReference | String | 1 | Specifies the algorithm used to compute digitalSignatureValue. For example "ECDSA-384-SHA2". |

: The Get By Link Operation Parameters. {#tbl:get_by_link_operation_parameters}

#### Interpretation Guidelines {#sec:interface_behaviour_operation_get_by_link_guide}

The unique **transactionIdentifier** given by the Upload By Link call.

If the provided transactionIdentifier is not valid, the response is HTTP code 404.

There is not specific time constraint for a data consumer to retrieve the results through the Get by Link operation. If however, the involved datasets have in the meantime been cancelled, the data provider is allowed to drop the pending transactions.


### Operation Get Summary {#sec:interface_behaviour_operation_get_summary}

The *Get Summary* operation is used by data consumers to discover the AtoN information that can be made available (and is accessible) by a data provider. The data provider will respond by listing the available (and accessible) S-125 datasets that are of interest to the consumer. This list should only contain summary information on each S-125 dataset, not the dataset content itself. UUID-based dataset identifiers can be used to retrieve the full S-125 datasets via the Get interface. The consumer can filter the requested S-125 dataset results through parameters like the dataset identifier, validity period and/or geometry etc.

The Get Summary operation interface must be implemented only by the data provider.

Use of the interface is according to the SECOM specification.

  * Name: Get Summary Interface 
  * Sub-path: /v2/object/summary
  * HTTP-Method: GET
  * Cookies: Session-Cookies (optional)
  * Content-Type: application/json

#### Operation Functionality {#sec:interface_behaviour_operation_get_summary_func}

All instances of this service design must provide access to the summary information of all S-125 datasets made available for their advertised coverage area. Each individual S-125 dataset should have a fixed MRN identifier associated with it, while each S-125 dataset update must be identified using a different unique UUID.

The operation supports multiple filter parameters, presented in more detail in [@tbl:get_summary_operation_parameters]. To ensure the authenticity of the operation request, the filter parameters are included within a signed SECOM envelope structure. Data provider instances are required to support all referenced filter parameters.

If multiple query parameters are provided, only results that match all requested filters, combined with logical AND, must be returned. If no parameters are given, the response is either an empty list or all available dataset summaries the consumer has been given access to by the service provider.

Depending on the combination of the  **containterType** and **validFrom**/**validTo** input parameter values, the data provider must respond differently:

* For the **containterType** set to **0** (S-100 Dataset): the service must respond with the latest summary information for all matching S-125 datasets. The **validFrom**/**validTo** should not be taken into account, as the data provider must never return out-of-date information. If however, the specified **dataReference** UUIDs represent the past state of a valid S-125 dataset (with the same MRN), *which has not been cancelled yet*, then the data provider must return the summary information for that exact dataset, once again disregarding the **validFrom**/**validTo** parameters. *The service must never return summary information regarding S-125 **delta** files if the containterType value is set to 0*.
* For the **containterType** set to **1** (S-100 Exchange-Set): the service must return the dataset summary information using the S-100 Exchange-Set structure. That involves the original content of the S-125 dataset (update 0), along with any incremental updates (for the same dataset MRN) in the form of S-100 ***delta*** files. If the **validFrom**/**validTo** parameters are utilised, any of the original content of the S-125 dataset and delta files should only be included in the Exchange-Set, if they fall within the specified time interval.

#### Operation Parameters {#sec:interface_behaviour_operation_get_summary_params}

| Parameters (in) | Encoding | Mult. | Descriptions |
| --- | --- | ---  | --- |
| containerType | Integer | 0..1 | Requested encoding of the data as described in [@cite:iec-63173-2]. If not provided, the service provider determines the standard encoding. |
| dataProductType | String | 0..1 | Data product type as described in [@cite:iec-63173-2]. |
| productVersion | String | 0..1 | S-100 based Product type version, e.g. 1.0.0. |
| geometry | String (WKT) | 0..1| Geometry condition for geo-located information objects in WKT format. This can be used to filter on geometric shapes (e.g., filter S-125 datasets by a bounding box). |
| unlocode | String | 0..1 | UN/LOCODE | (United Nations Code for Trade and Transport Locations) of a defined object (e.g., “CN” for China). |
| validFrom | DateTime | 0..1 | Describes the start of the validity time for the requested data in ISO 8601 UTC formatted as yyyy-mm-dd hh:mmZ. |
| validTo | DateTime | 0..1 | Describes the end of the validity time for the requested data in ISO 8601 UTC formatted as yyyy-mm-dd hh:mmZ. |
| page | Integer | 0..1 | The number of the page for retrieving paged results. If not provided, the default value of this parameter is set to zero (0). |
| pageSize | Integer | 0..1 | The size of each page in a paged result. If not provided, the default value of this parameter is not set and the resulting S-125 datasets are not paged. |

: The Get Summary Operation Parameters. {#tbl:get_summary_operation_parameters}

#### Interpretation Guidelines {#sec:interface_behaviour_operation_get_summary_guide}

In the response, the **dataReference** is given as a UUID for each data object listed. The dataReference can then be provided as input to a Get call.

The **dataProtection** flag indicates whether the data is encrypted or not. If encrypted, an encryptionKey is required to decrypt the data.

The **compression** flag indicates whether the data is compressed with ZIP or not.

The **dataProductType** and **productVersion** indicate type and version of the data specification for the data object. For the purpose of this service design, the data product type must always be "S-125" as per the format specified in S-100 [@cite:iho-s100].

The **info_identifier**, **info_name**, **info_status**, **info_description**, and **info_lastModifiedData** are describing each matching S-125 dataset. 

The **info_size** represents the file size of the S-125 dataset, as returned by Get data. The size does not include the envelope.

The **validFrom**/**validTo** describes the requested validity time for the requested data in ISO 8601 UTC formatted as yyyy-mm-dd hh:mm:ssZ.


### Operation Subscription {#sec:interface_behaviour_operation_subscription}

The purpose of the *Subscription* operation is for service consumers to request a new or cancel an existing subscription on AtoN information. Subscriptions are made either on specific parameters, otherwise these are decided by the data provider.

The Subscription operation interface must be implemented only by the data provider.

Use of the interface is according to the SECOM specification.

  * Name: Subscription Interface 
  * Sub-path: /v2/subscription
  * HTTP-Method: POST
  * Cookies: Session-Cookies (optional)
  * Content-Type: application/json

#### Operation Functionality {#sec:interface_behaviour_operation_subscription_func}

In SECOM, the data provider may then use the URL available in the `<callbackEndpoint>` parameter to contact the data consumer directly and send any available subscription updates. In the absence of a valid callback endpoint value, the data provider may discover the consumer's URL utilising an appropriate Service Registry (e.g. MSR). The data consumer can be identified through its MRN, contained in the HTTPS request certificate provided during the TLS/SSL authentication step. This workaround is compatible with the specifications of SECOM v1.0 and allows the service to identify the data consumer and locate its uploading interface. More information on the dynamic behaviour of the subscription operation and its relation to the SECOM-compliant service registry is provided in [@sec:dynamic_behaviour_subscription_retrieval].

The service needs to keep track of the following operations:

* New subscriptions
* Changes between two points in time (S-125 delta files)
* Cancellation of datasets

Once the subscription request is received and processed successfully, the service will create a new subscription record for the respective client and return a unique UUID identifier for that record. The response containing with the generated are presented in the example service response.

A subscription can be cancelled through the *Remove Subscription* operation. More information can be found in [@sec:interface_behaviour_operation_remove_subscription].

The operation interface consumes the following consumer interfaces:

* Upload
* Subscription Notification

The Upload consumer interface can be used by the data provider to push bew and/or updated S-125 datasets to the subscribed service consumer. The Subscription Notification consumer interface on the other hand, is used to inform the consumer that on the status of the subscription, i.e., when it has been successfully activated or removed. More information on this operation can be found in [@sec:dynamic_behaviour_client_init_retrieval]. Note that for each new subscription, a Subscription Identifier should be made available to the consumer though the interface’s response.

The operation supports multiple filter parameters, presented in more detail in [@tbl:get_subscription_operation_parameters]. To ensure the authenticity of the operation request, the filter parameters are included within a signed SECOM envelope structure. Data provider instances are required to support all referenced filter parameters.

All criteria for the subscription are optional. If none are provided, all authorized data from the data provider will be included in the subscription. If more than one criteria is provided, these must be combined with a logical AND, hence all criteria must be met.

#### Operation Parameters {#sec:interface_behaviour_operation_subscription_params}

| Parameters (in) | Encoding | Mult. | Descriptions |
| --- | --- | ---  | --- |
| containerType | Integer | 0..1 | Requested encoding of the data as described in [@cite:iec-63173-2]. If not provided, the service provider determines the standard encoding. |
| dataProductType | String | 0..1 | Data product type as described in [@cite:iec-63173-2]. |
| productVersion | String | 0..1 | S-100 based Product type version, e.g. 1.0.0. |
| dataReference | UUID | 0..1 | Dataset reference identifier to a specific S-125 dataset. The reference can be provided as search criteria. A list of references can be retrieved via Get Summary interface. If no references are provided. |
| geometry | String (WKT) | 0..1| Geometry condition for geo-located information objects in WKT format. This can be used to filter on geometric shapes (e.g., filter S-125 datasets by a bounding box). |
| unlocode | String | 0..1 | UN/LOCODE (United Nations Code for Trade and Transport Locations) of a defined object (e.g., “CN” for China). |
| subscriptionPeriodStart | DateTime | 0..1 | The start date and time for which the subscription is active. |
| subscriptionPeriodEnd | DateTime | 0..1 | The end date and time for which the subscription is active. |
| callbackEndpoint | URL | 0..1 | Base URL to the requestor's SECOM service Attribute Messages within subscription are sent to callbackEndpoint/object. If not availalble, the baseUrl needs to be available through search service. |
| pushAll | Boolean | 0..1 | Flag for sending an initial set of data within requested subscription and then start the subscription.<br/> If false, only data updates from the start of the subscription will be sent. |

: The Subscription Operation Parameters. {#tbl:get_subscription_operation_parameters}

#### Interpretation Guidelines {#sec:interface_behaviour_operation_subscription_guide}

The **dataReference** criteria means that only new updates of the specific S-125 dataset will be sent in the subscription. If the dataReference dataset is cancelled or deleted, the subscription ends.

The **containterType** describes how the data is packaged, e.g. 0 for a S-100 DataSet, 1 for a S-100 Exchange-Set or 2 for no specific container, e.g. RTZ in XML.

The **dataProductType** and **productVersion** criteria means that only information of the type and version will be sent in the subscription. For the purpose of this service design, the data product type must always "S-125" as per the format specified in S-100 [@cite:iho-s100].

The **geometry** describes geographical criteria for the data requested. The geometry is given as a one-line WKT formatted string and can contain one or more geographical objects. 

The **unlocode** criteria means that only information related to the unlocode will be sent in the subscription. If there is no unlocode related to the information provided by the service, the unlocode is ignored.

The **subscriptionPeriodStart** and **subscriptionPeriodEnd** criteria mean that data produced in the given time period will be sent in the subscription. When subscriptionPeriodEnd is reached, the subscription shall be removed automatically. The time period is recommended to be formatted in ISO 8601 UTC as yyyy-mm-dd hh:mm:ssZ.

The **callbackEndpoint** optionally contains the URL of the data consumers. The service may use that information to contact the data consumer when updates are available for an established subscription. If that information is not available, the data provider should search for the data consumer using the provided MRN in the appropriate Service Registry (e.g. MSR).

The **pushAll** flag signals that the service is expected push the latest S-125 datasets covered by a subscription to the data consumer, right after the subscription has been established. This removes the requirement for data consumers to always pull the data manually when creating a subscription.


### Operation Remove Subscription {#sec:interface_behaviour_operation_remove_subscription}

The *Remove Subscription* operation can be used to remove subscriptions that were created earlier through the Subscribe operation. It follows a one-way paradigm (ONE_WAY), where a client sends data to consumer without expecting information back, other than a technical response. 

The Remove Subscription operation interface must be implemented only by the data provider.

Use of the interface is according to the SECOM specification.

  * Name: Remove Subscription Interface 
  * Sub-path: /v2/subscription
  * HTTP-Method: DELETE
  * Cookies: Session-Cookies (optional)
  * Content-Type: application/json

#### Operation Functionality {#sec:interface_behaviour_operation_remove_subscription_func}

The SECOM interface specification is not clear on whether the MRN of the data consumer that originally requested the subscription is to be checked against the MRN of the actor who performed this request. It is therefore assumed that any valid data consumer can terminate an existing subscription. A notification is then expected to inform the subscribed data consumer. If no subscription identifier parameter is specified, the service will respond with an error code and an appropriate message.

The operation interface consumes the following consumer interfaces:

* Subscription Notification

The Subscription Notification consumer interface is used to inform the consumer that on the status of the subscription, i.e. when it has been successfully removed.

#### Operation Parameters {#sec:interface_behaviour_operation_remove_subscription_params}

| Parameters (in) | Encoding | Mult. | Descriptions |
| --- | --- | ---  | --- |
| subscriptionIdentifier | UUID | 1 | Specific identifier of the active subscription to be removed. Typically received by the data consumer after a subscription request or through a subscription notification. |

: The Remove Subscription Operation Parameters. {#tbl:remove_subscription_operation_parameters}

#### Interpretation Guidelines {#sec:interface_behaviour_operation_remove_subscription_guide}

The incoming ***subscriptionIdentifier*** given when the subscription was created and provided in the Subscription Notification, is used to remove the corresponding subscription.


### Operation Subscription Notification {#sec:interface_behaviour_operation_subscription_notification}

The *Subscription Notification* operation receives notifications by data provider, when a subscription is created or removed.

The Subscription Notification operation interface must be implemented only by the data consumer.

Use of the interface is according to the SECOM specification.

  * Name: Subscription Notification Interface 
  * Sub-path: /v2/subscription/notification
  * HTTP-Method: POST
  * Cookies: Session-Cookies (optional)
  * Content-Type: application/json
  
#### Operation Functionality {#sec:interface_behaviour_operation_subscription_notification_func}

The data provider is not required to call the subscriptionNotification of the consumer unless the creation or removal of the subscription requires asynchronous action or is the result of a maintenance operation. If the subscription and removeSubscription are synchronous processes when called from the data provider, then the subscriptionNotification is not required.

The operation two parameters, presented in more detail in [@tbl:subscription_notification_operation_parameters]. To ensure the authenticity of the operation request, these parameters are included within a signed SECOM envelope structure.

#### Operation Parameters {#sec:interface_behaviour_operation_subscription_notification_params}

| Parameters (in) | Encoding | Mult. | Descriptions |
| --- | --- | ---  | --- |
| subscriptionIdentifier | UUID | 1 | Specific identifier of the subscription for which the status has being updated. |
| eventEnum | SubscriptionEventEnum as defined in [@cite:iec-63173-2]. | 1 | Type of subscription status update event e.g., Created or Removed. |

: The Subscription Notification Operation Parameters. {#tbl:subscription_notification_operation_parameters}

#### Interpretation Guidelines {#sec:interface_behaviour_operation_subscription_notification_guide}

The **subscriptionIdentifier** is the reference to the specific subscription in focus.

The **eventEnum** describes the type of event, e.g. 1 when the subscription is created and "2" when the subscription is removed.


### Operation Upload {#sec:interface_behaviour_operation_upload}

The *Upload* operation enables data providers to upload (push) AtoN information to the data consumers. It allows consumers to receive S-125 datasets, while in a subscription or a due to a broadcast.

The Upload operation interface must be implemented only by the data consumers.

Use of the interface is according to the SECOM specification.

  * Name: Upload Interface 
  * Sub-path: /v2/object
  * HTTP-Method: POST
  * Cookies: Session-Cookies (optional)
  * Content-Type: application/json

#### Operation Functionality {#sec:interface_behaviour_operation_upload_func}

In most cases this operation will take place as part of a subscription, originally initiated by the data consumer. In those cases the `<fromSubscription>` parameters is expected to be set to `true`. There might however, be cases where urgent AtoN information might need to be broadcasted, therefore data consumer uploads may also take place outside active subscriptions. These cases however are not covered by this service design.

This interface operation may on request consume the following provider interfaces:

* Acknowledgement

In an upload operation, an acknowledgement can be requested via the `<ackRequest>` parameter. The acknowledgment is expected to be received when the uploaded S-125 dataset has been delivered to the end‑system (technical acknowledgement), and/or (if supported) when the message has been opened/read by the end‑user (operational acknowledgement).

The data consumer may then use the URL available in the `<callbackEndpoint>` parameter to contact the data provider directly and send the required acknowledgement. In the absence of a valid callback endpoint value, the data consumer may discover the server URL utilising an appropriate Service Registry (e.g. MSR). The data provider can be identified through its MRN, contained in the HTTPS request certificate provided during the TLS/SSL authentication step, as in [@sec:interface_behaviour_operation_subscription_func]. More information on the dynamic behaviour of this operation and its relation to the SECOM-compliant service registry is provided in [@sec:dynamic_behaviour_client_init_retrieval].

The operation supports multiple other parameters, which are presented in more detail in [@tbl:upload_operation_parameters]. To ensure the authenticity of the operation request, these parameters are included within a signed SECOM envelope structure.

#### Operation Parameters {#sec:interface_behaviour_operation_upload_params}

| Parameters (in) | Encoding | Mult. | Descriptions |
| --- | --- | ---  | --- |
| data | Base64 | 1 | The S-125 XML payload, Base64 encoded. Optionally, the data can protected and/or compressed. This should be reflected in the exchangeMetadata structure. |
| containerType | Integer | 0..1 | Requested encoding of the data as described in [@cite:iec-63173-2]. If not provided, the service provider determines the standard encoding. |
| dataProductType | String | 0..1 | Data product type as described in [@cite:iec-63173-2]. |
| exchangeMetadata | SECOM_ExchangeMetadata as defined in [@cite:iec-63173-2] | 1 | The exchange metadata that contains information regarding the protection scheme, compression, signature and claimed identity. |
| fromSubscription | Boolean | 1 | A flag that indicates whether the data has been uploaded within an active subscription or not. |
| subscriptionIdentifier | UUID | 0..1 | Subscription identifier is specified if the object is uploaded within a subscription. |
| ackRequest | AckRequestEnum as defined in [@cite:iec-63173-2] | 1 | Flag to indicate that acknowledgement is expected to be returned when the data is delivered to the end user, and/or when the content of the data is processed (opened) by the end user.|
| callbackEndpoint | URL | 0..1 | Base URL without trailing slash to the requestor SECOM service Endpoint where to send an acknowledgement. If not available, the endpoint needs to be available through the search service. |
| transactionIdentifier | UUID | 1 | Unique transaction UUID to be used e.g. in acknowledgement. |
| envelopeSignatureCertificate | String | 1..* | The public certificate(s) of the sender. Used to verify the envelope object signature. |
| envelopeRootCertificateThumbprint | String | 1 | Claimed Thumbprint for Signed Root Key (X.509 Certificate) SHA256 and base64 as format |
| envelopeSignatureTime | DateTime | 1 | Timestamp when the envelope is signed. |
| envelopeSignatureReference | String | 1 | (S-100) Specifies the algorithm used to compute the envelopeSignature For example "ECDSA-384-SHA2". |

: The Upload Operation Parameters. {#tbl:upload_operation_parameters}

#### Interpretation Guidelines {#sec:interface_behaviour_operation_upload_guide}

If any of the upload request S-125 datasets is too large, the returned HTTP status code must be 413. The S-125 datasets must then be shared using the upload link interface.

The data consumer may return HTTP status 403 if the uploaded AtoN information it receives that it has not requested. 


### Operation Upload by Link {#sec:interface_behaviour_operation_upload_by_link}

The *Upload by Link* operation enables data providers to provide a link to large volumes of AtoN information to data consumers. This interface shall be used instead of the Upload operation, when the size of the data to be exchanged exceeds the predefined SECOM limits. It allows data consumers to receive large S-125 datasets, while in a subscription or a due to a broadcast.

The Upload by Link operation interface must be implemented only by the data consumers.

Use of the interface is according to the SECOM specification.

  * Name: Upload by Link Interface 
  * Sub-path: /v2/object/link
  * HTTP-Method: POST
  * Cookies: Session-Cookies (optional)
  * Content-Type: application/json

#### Operation Functionality {#sec:interface_behaviour_operation_upload_by_link_func}

In most cases the Upload by Link operation will take place as part of a subscription, initiated by the data consumer. It must be used instead of the Upload operation when the S-125 datasets to be transmitted exceed 350 kbs. In those cases, the `<fromSubscription>` parameters is expected to be set to `true`. There might however, be cases where urgent AtoN information might need to be broadcasted, therefore data consumer uploads may also take place outside active subscriptions. These cases however are not covered by this service design.

This interface operation may on request consume the following provider interfaces:

* Acknowledgement

In an upload by link operation, an acknowledgement can be requested via the `<ackRequest>` parameter. The acknowledgment is expected to be received when the uploaded S-125 dataset has been delivered to the end‑system (technical acknowledgement), and/or (if supported) when the message has been opened/read by the end‑user (operational acknowledgement).

The data consumer may then use the URL available in the `<callbackEndpoint>` parameter to contact the data provider directly and get the advertised S-125 datasets, as well as send the required acknowledgement. In the absence of a valid callback endpoint value, the data consumer may discover the server URL utilising an appropriate Service Registry (e.g. MSR). The data provider can be identified through its MRN, contained in the HTTPS request certificate provided during the TLS/SSL authentication step, as in [@sec:interface_behaviour_operation_subscription_func]. More information on the dynamic behaviour of this operation and its relation to the SECOM-compliant service registry is provided in [@sec:dynamic_behaviour_client_init_retrieval].

As in the Upload operation described previously, this operation supports multiple other parameters, which are presented in more detail in [@tbl:upload_by_link_operation_parameters]. To ensure the authenticity of the operation request, these parameters are included within a signed SECOM envelope structure.

#### Operation Parameters {#sec:interface_behaviour_operation_upload_by_link_params}

| Parameters (in) | Encoding | Mult. | Descriptions |
| --- | --- | ---  | --- |
| containerType | Integer | 0..1 | Requested encoding of the data as described in [@cite:iec-63173-2]. If not provided, the service provider determines the standard encoding. |
| dataProductType | String | 0..1 | Data product type as described in [@cite:iec-63173-2]. |
| exchangeMetadata | SECOM_ExchangeMetadata as defined in [@cite:iec-63173-2] | 1 | The exchange metadata that contains information regarding the protection scheme, compression, signature and claimed identity. |
| fromSubscription | Boolean | 1 | A flag that indicates whether the data has been uploaded within an active subscription or not. |
| subscriptionIdentifier | UUID | 0..1 | Subscription identifier is specified if the object is uploaded within a subscription. |
| ackRequest | AckRequestEnum as defined in [@cite:iec-63173-2] | 1 | Flag to indicate that acknowledgement is expected to be returned when the data is delivered to the end user, and/or when the content of the data is processed (opened) by the end user.|
| callbackEndpoint | URL | 0..1 | Base URL without trailing slash to the requestor SECOM service Endpoint where to send an acknowledgement. If not available, the endpoint needs to be available through the search service. |
| transactionIdentifier | UUID | 1 | Unique transaction UUID to be used e.g. in acknowledgement. |
| envelopeSignatureCertificate | String | 1..* | The public certificate(s) of the sender. Used to verify the envelope object signature. |
| envelopeRootCertificateThumbprint | String | 1 | Claimed Thumbprint for Signed Root Key (X.509 Certificate) SHA256 and base64 as format |
| size |  Integer | 1 | Size of the data in kBytes to be downloaded. |
| timeToLive | DateTime | 1 | Timestamp when data will be deleted on server. The data need to be fetched before this time. |
| envelopeSignatureTime | DateTime | 1 | Timestamp when the envelope is signed. |
| envelopeSignatureReference | String | 1 | (S-100) Specifies the algorithm used to compute the envelopeSignature For example "ECDSA-384-SHA2" |

: The Upload Operation Parameters. {#tbl:upload_by_link_operation_parameters}

#### Interpretation Guidelines {#sec:interface_behaviour_operation_upload_by_link_guide}

The Upload by Link operation should always be used when the server identifies that the size of the data to be transmitted exceed the predefined SECOM limit, or when the previously attempted upload operation failed with an HTTP 413 error code.

The data consumer may return HTTP status 403 if the uploaded AtoN information it receives that it has not requested. 


### Operation Acknowledgment {#sec:interface_behaviour_operation_acknowledgment}

The *Acknowledgment* operation allows data consumers to asynchronously confirm whether an uploaded S-125 dataset has been successfully received and/or opened by an end-user. 

It is not yet clear on whether acknowledgements are necessary for the provision of AtoN information to end-users. Regardless, for the purposes of this service design,the Acknowledgment operation interface must be implemented only by the data consumers.

Use of the interface is according to the SECOM specification.

  * Name: Acknowledgment Interface 
  * Sub-path: /v2/acknowledgement
  * HTTP-Method: POST
  * Cookies: Session-Cookies (optional)
  * Content-Type: application/json

#### Operation Functionality {#sec:interface_behaviour_operation_acknowledgment_func}

The operation validates the given transactionIdentifier and handles the acknowledgement of sent data. The acknowledgement can be either for when the S-125 dataset has been delivered, opened or both. The acknowledgement contains a reference to the object delivered and has no time limit.

#### Operation Parameters {#sec:interface_behaviour_operation_acknowledgment_params}

| Parameters (in) | Encoding | Mult. | Descriptions |
| --- | --- | ---  | --- |
| createdAt | DateTime | 1 | Creation time for the acknowledgement. |
| envelopeCertificate | String | 1..* | The public certificate of the sender. used to verify the envelope signature |
| envelopeRootCertificateThumbprint | String | 1 | Claimed Thumbprint for Signed Root Key (X.509 Certificate) SHA256 and base64 as format. |
| transactionIdentifier | String | 1 |  Reference identifier given in upload. |
| ackType | AckTypeEnumType as defined in [@cite:iec-63173-2] | 1 | Type of of acknowledgement. |
| nackType | NackTypeEnum as defined in [@cite:iec-63173-2] | 0..1 | NackTypeEnum Information details if error. |
| envelopeSignatureTime | DateTime | 0..1 | Timestamp when the envelope is signed |
| envelopeSignatureReference | String | 1 | Specifies the algorithm used to compute envelope signature. For example "ECDSA-384-SHA2" |

: The Acknowledgment Operation Parameters. {#tbl:acknowledgment_operation_parameters}

#### Interpretation Guidelines {#sec:interface_behaviour_operation_acknowledgment_guide}

The **transactionIdentifier** describes the reference to what sending transaction of data that is acknowledged.

The response can be either positive acknowledgement (ackType = 1 or 2) or negative acknowledgement (ackType = 3 (error)). If negative acknowledgement is given, the error message is expected to be provided in nackType (0-4) describing the error.



